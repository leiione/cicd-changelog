  update-changelog:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Generate and push changelog
          command: |
            set -e
            sudo apt-get update && sudo apt-get install -y jq git

            git config --global user.email "ci-bot@example.com"
            git config --global user.name "CI Bot"

            git clone https://${GH_CHANGELOG_TOKEN}@github.com/leiione/cicd-changelog.git
            cd cicd-changelog

            git remote set-url origin https://${GH_CHANGELOG_TOKEN}@github.com/leiione/cicd-changelog.git

            # Extract commits from past 7 days (excluding merges)
            COMMIT_LOG=$(git log --since="7 days ago" --pretty=format:'- %h %an: %s' --no-merges | sort -u)
            COMMITS_JSON=$(echo "$COMMIT_LOG" | jq -R . | jq -s .)

            {
              echo "["
              echo "  {"
              echo "    \"date\": \"$(date +%F)\","
              echo "    \"message\": \"âœ… ${CIRCLE_BRANCH} deployed via ${CIRCLE_JOB}\","
              echo "    \"commits\": $COMMITS_JSON"
              echo "  }"
              echo "]"
            } > changelog.json

            git add changelog.json
            git commit -m "CI: ${CIRCLE_BRANCH} changelog update from ${CIRCLE_JOB}" || echo "No changes to commit"
            git pull origin main --rebase
            git push origin main
